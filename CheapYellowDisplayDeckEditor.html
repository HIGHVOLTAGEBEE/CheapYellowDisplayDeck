<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>
<title>CYD Deck Editor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Arial,sans-serif;background:#0a0e27;color:#e4e7eb;padding:0;overflow-x:hidden}
.top-bar{background:linear-gradient(135deg,#1a1f3a 0%,#2d1b4e 100%);border-bottom:2px solid #4a5568;padding:20px 30px;position:sticky;top:0;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,0.4)}
.top-bar h1{color:#a78bfa;margin-bottom:15px;font-size:26px;font-weight:600;letter-spacing:0.5px}
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.btn-primary{background:linear-gradient(135deg,#8b5cf6 0%,#6d28d9 100%);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s;box-shadow:0 2px 8px rgba(139,92,246,0.3)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(139,92,246,0.5)}
.btn-secondary{background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s;box-shadow:0 2px 8px rgba(59,130,246,0.3)}
.btn-secondary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(59,130,246,0.5)}
.btn-danger{background:linear-gradient(135deg,#ef4444 0%,#b91c1c 100%);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s;box-shadow:0 2px 8px rgba(239,68,68,0.3)}
.btn-danger:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(239,68,68,0.5)}
.menu-tabs{display:flex;gap:8px;overflow-x:auto;padding:20px 30px;background:#12172e;border-bottom:1px solid #2d3748;scrollbar-width:thin;scrollbar-color:#4a5568 #1a202c}
.menu-tabs::-webkit-scrollbar{height:8px}
.menu-tabs::-webkit-scrollbar-track{background:#1a202c}
.menu-tabs::-webkit-scrollbar-thumb{background:#4a5568;border-radius:4px}
.menu-tab{background:#1f2937;color:#9ca3af;border:1px solid #374151;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;white-space:nowrap;transition:all 0.3s}
.menu-tab:hover{background:#374151;color:#e4e7eb}
.menu-tab.active{background:linear-gradient(135deg,#8b5cf6 0%,#6d28d9 100%);color:#fff;border-color:#8b5cf6;box-shadow:0 2px 8px rgba(139,92,246,0.4)}
.container{max-width:1400px;margin:0 auto;padding:30px}
.menu{background:#161b33;padding:30px;border-radius:16px;margin-bottom:25px;border:1px solid #2d3748;box-shadow:0 4px 16px rgba(0,0,0,0.3);display:none}
.menu.active{display:block}
.menu-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;gap:15px;flex-wrap:wrap;padding-bottom:20px;border-bottom:2px solid #2d3748}
.menu-header input{flex:1;min-width:250px;background:#0f1629;color:#e4e7eb;border:2px solid #374151;padding:12px 16px;border-radius:10px;font-size:15px;transition:all 0.3s}
.menu-header input:focus{outline:none;border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,0.1)}
.menu-info{display:flex;gap:15px;align-items:center;flex-wrap:wrap}
label.select-label{color:#9ca3af;font-size:13px;font-weight:500;margin-right:8px}
select{background:#0f1629;color:#e4e7eb;border:2px solid #374151;padding:10px 14px;border-radius:8px;font-size:14px;cursor:pointer;transition:all 0.3s}
select:focus{outline:none;border-color:#8b5cf6}
.btn-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-top:25px}
.btn-config{background:#0f1629;padding:24px;border-radius:12px;border:1px solid #2d3748;transition:all 0.3s}
.btn-config:hover{border-color:#4a5568;box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.btn-config h3{color:#a78bfa;font-size:15px;margin-bottom:18px;font-weight:600;padding-bottom:12px;border-bottom:1px solid #2d3748}
.btn-config label{display:block;margin:14px 0 8px;color:#9ca3af;font-size:13px;font-weight:500}
.btn-config input[type=text]{width:100%;background:#1a1f3a;color:#e4e7eb;border:1px solid #374151;padding:10px 12px;border-radius:8px;font-size:14px;transition:all 0.3s}
.btn-config input[type=text]:focus{outline:none;border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,0.1)}
.btn-config select{width:100%;background:#1a1f3a;color:#e4e7eb;border:1px solid #374151;padding:10px 12px;border-radius:8px;font-size:14px}
.checkbox-label{display:flex;align-items:center;margin:14px 0;cursor:pointer;user-select:none}
.checkbox-label input[type=checkbox]{width:20px;height:20px;margin-right:10px;cursor:pointer;accent-color:#8b5cf6}
.checkbox-label span{color:#e4e7eb;font-size:14px;font-weight:500}
.color-row{display:flex;gap:12px;align-items:center}
.color-preview{width:50px;height:40px;border-radius:8px;border:2px solid #374151;cursor:pointer;transition:all 0.3s;box-shadow:0 2px 6px rgba(0,0,0,0.3)}
.color-preview:hover{transform:scale(1.05);border-color:#8b5cf6}
.image-upload-area{margin-top:12px;padding:15px;background:#1a1f3a;border:2px dashed #374151;border-radius:8px;text-align:center;cursor:pointer;transition:all 0.3s}
.image-upload-area:hover{border-color:#8b5cf6;background:#0f1629}
.image-upload-area.has-image{border-style:solid;border-color:#10b981}
.upload-label{display:block;color:#9ca3af;font-size:13px;margin-bottom:10px}
.image-preview-container{display:flex;align-items:center;justify-content:center;gap:15px;flex-wrap:wrap}
.image-preview{width:67px;height:67px;border:2px solid #4a5568;border-radius:6px;object-fit:cover;background:#0a0e27}
.upload-info{color:#60a5fa;font-size:12px;margin-top:8px}
.remove-image{background:#ef4444;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer;margin-top:8px}
.remove-image:hover{background:#dc2626}
input[type=file]{display:none}
.status{position:fixed;bottom:30px;right:30px;padding:16px 24px;border-radius:10px;display:none;font-size:14px;font-weight:500;box-shadow:0 4px 16px rgba(0,0,0,0.4);z-index:1000;animation:slideIn 0.3s ease}
.status.success{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff}
.status.error{background:linear-gradient(135deg,#ef4444 0%,#b91c1c 100%);color:#fff}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
canvas{display:none}
</style>
</head>
<body>
<div class='top-bar'>
<h1>üéÆ CheapYellowDisplayDeck Editor by HIGHVOLTAGEBEE</h1>
<div class='controls'>
<button class='btn-primary' onclick='downloadPackage()'>üì¶ Download Package (ZIP)</button>
<button class='btn-secondary' onclick='loadConfig()'>üìÇ Load config.json</button>
<button class='btn-secondary' onclick='addMenu()'>‚ûï Add Menu</button>
<button class='btn-secondary' onclick='location.reload()'>‚Üª Reset Editor</button>
</div>
</div>

<input type='file' id='fileInput' accept='.json' onchange='handleFileLoad(event)'>
<input type='file' id='imageInput' accept='image/*' onchange='handleImageUpload(event)'>

<div class='menu-tabs' id='tabs'></div>
<div class='container' id='menus'></div>
<div class='status' id='status'></div>
<canvas id='canvas'></canvas>

<script>
let cfg = {
  menuCount: 1,
  menus: [{
    name: 'Main Menu',
    parent: -1,
    buttons: []
  }]
};

for(let i = 0; i < 12; i++) {
  cfg.menus[0].buttons.push({
    active: false,
    color: 0x2196,
    text: '',
    icon: '',
    action: '',
    target: -1,
    imageData: null
  });
}

let activeMenu = 0;
let currentUploadButton = null;

function showStatus(msg, type) {
  type = type || 'success';
  let s = document.getElementById('status');
  s.textContent = msg;
  s.className = 'status ' + type;
  s.style.display = 'block';
  setTimeout(() => s.style.display = 'none', 3000);
}

function switchMenu(idx) {
  activeMenu = idx;
  render();
}

function render() {
  let tabs = '';
  for(let m = 0; m < cfg.menuCount; m++) {
    tabs += "<div class='menu-tab " + (m === activeMenu ? "active" : "") + "' onclick='switchMenu(" + m + ")'>" + cfg.menus[m].name + "</div>";
  }
  document.getElementById('tabs').innerHTML = tabs;
  
  let h = '';
  for(let m = 0; m < cfg.menuCount; m++) {
    let menu = cfg.menus[m];
    h += "<div class='menu " + (m === activeMenu ? "active" : "") + "'><div class='menu-header'><input type='text' value='" + menu.name + "' onchange='cfg.menus[" + m + "].name=this.value;render()' placeholder='Menu Name'>";
    h += "<div class='menu-info'><label class='select-label'>Parent Menu:</label><select onchange='cfg.menus[" + m + "].parent=parseInt(this.value)'><option value='-1'>Main Menu</option>";
    
    for(let i = 0; i < cfg.menuCount; i++) {
      if(i !== m) {
        h += "<option value='" + i + "' " + (menu.parent === i ? "selected" : "") + ">" + cfg.menus[i].name + "</option>";
      }
    }
    
    h += "</select><button class='btn-danger' onclick='delMenu(" + m + ")'>üóëÔ∏è Delete Menu</button></div></div><div class='btn-grid'>";
    
    for(let i = 0; i < 12; i++) {
      let b = menu.buttons[i];
      h += "<div class='btn-config'><h3>Button " + (i + 1) + "</h3>";
      h += "<div class='checkbox-label'><input type='checkbox' " + (b.active ? "checked" : "") + " onchange='cfg.menus[" + m + "].buttons[" + i + "].active=this.checked'><span>Active</span></div>";
      
      if(!b.imageData) {
        h += "<label>Button Text</label><input type='text' value='" + b.text + "' onchange='cfg.menus[" + m + "].buttons[" + i + "].text=this.value'>";
      }
      
      h += "<label>Action Type</label><select onchange='updateAction(" + m + "," + i + ",this.value)'>";
      h += "<option value='hotkey' " + (b.target < 0 ? "selected" : "") + ">Hotkey</option>";
      h += "<option value='menu' " + (b.target >= 0 ? "selected" : "") + ">Menu Link</option></select>";
      h += "<div id='act_" + m + "_" + i + "'>";
      
      if(b.target < 0) {
        h += "<label>Hotkey Combination</label><input type='text' value='" + b.action + "' onchange='cfg.menus[" + m + "].buttons[" + i + "].action=this.value' placeholder='CTRL+C'>";
      } else {
        h += "<label>Target Menu</label><select onchange='cfg.menus[" + m + "].buttons[" + i + "].target=parseInt(this.value)'><option value='-1'>None</option>";
        for(let mn = 0; mn < cfg.menuCount; mn++) {
          h += "<option value='" + mn + "' " + (b.target === mn ? "selected" : "") + ">" + cfg.menus[mn].name + "</option>";
        }
        h += "</select>";
      }
      
      h += "</div>";
      
      if(!b.imageData) {
        h += "<label>Button Color</label><div class='color-row'><div class='color-preview' style='background:#" + rgb565ToHex(b.color) + "' onclick='document.getElementById(\"col_" + m + "_" + i + "\").click()'></div>";
        h += "<input type='color' id='col_" + m + "_" + i + "' style='display:none' value='#" + rgb565ToHex(b.color) + "' onchange='cfg.menus[" + m + "].buttons[" + i + "].color=hexToRgb565(this.value);render()'>";
        h += "</div>";
      }
      
      h += "<label>Button Icon (67x67px)</label>";
      h += "<div class='image-upload-area " + (b.imageData ? "has-image" : "") + "' onclick='openImageUpload(" + m + "," + i + ")'>";
      
      if(b.imageData) {
        h += "<div class='image-preview-container'>";
        h += "<img src='" + b.imageData + "' class='image-preview' alt='Preview'>";
        h += "<div><span class='upload-info'>‚úì Image ready</span><br>";
        h += "<button class='remove-image' onclick='event.stopPropagation();removeImage(" + m + "," + i + ")'>Remove</button></div>";
        h += "</div>";
      } else {
        h += "<span class='upload-label'>üì∑ Click to upload image</span>";
        h += "<span class='upload-info'>Accepts: JPG, PNG, GIF, WebP</span>";
      }
      
      h += "</div></div>";
    }
    h += "</div></div>";
  }
  document.getElementById('menus').innerHTML = h;
}

function hexToRgb565(hex) {
  let r = parseInt(hex.slice(1, 3), 16) >> 3;
  let g = parseInt(hex.slice(3, 5), 16) >> 2;
  let b = parseInt(hex.slice(5, 7), 16) >> 3;
  return (r << 11) | (g << 5) | b;
}

function rgb565ToHex(rgb565) {
  let r = ((rgb565 >> 11) & 0x1F) << 3;
  let g = ((rgb565 >> 5) & 0x3F) << 2;
  let b = (rgb565 & 0x1F) << 3;
  r = r | (r >> 5);
  g = g | (g >> 6);
  b = b | (b >> 5);
  return r.toString(16).padStart(2, '0') + g.toString(16).padStart(2, '0') + b.toString(16).padStart(2, '0');
}

function updateAction(m, i, type) {
  let b = cfg.menus[m].buttons[i];
  if(type === 'hotkey') {
    b.action = '';
    b.target = -1;
  } else {
    b.action = '';
    b.target = 0;
  }
  render();
}

function openImageUpload(m, i) {
  currentUploadButton = {menu: m, button: i};
  document.getElementById('imageInput').click();
}

function handleImageUpload(event) {
  let file = event.target.files[0];
  if(!file || !currentUploadButton) return;
  
  let reader = new FileReader();
  reader.onload = function(e) {
    let img = new Image();
    img.onload = function() {
      let canvas = document.getElementById('canvas');
      let ctx = canvas.getContext('2d');
      
      canvas.width = 67;
      canvas.height = 67;
      
      ctx.drawImage(img, 0, 0, 67, 67);
      
      let dataUrl = canvas.toDataURL('image/png');
      
      cfg.menus[currentUploadButton.menu].buttons[currentUploadButton.button].imageData = dataUrl;
      cfg.menus[currentUploadButton.menu].buttons[currentUploadButton.button].icon = '/i_' + currentUploadButton.menu + '_' + currentUploadButton.button + '.bin';
      cfg.menus[currentUploadButton.menu].buttons[currentUploadButton.button].color = 0x0000;
      cfg.menus[currentUploadButton.menu].buttons[currentUploadButton.button].text = '';
      
      render();
      showStatus('‚úì Image uploaded and resized!', 'success');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
  
  event.target.value = '';
}

function removeImage(m, i) {
  cfg.menus[m].buttons[i].imageData = null;
  cfg.menus[m].buttons[i].icon = '';
  cfg.menus[m].buttons[i].text = '';
  render();
  showStatus('‚úì Image removed!', 'success');
}

function imageDataToRgb565(dataUrl) {
  return new Promise((resolve) => {
    let img = new Image();
    img.onload = function() {
      let canvas = document.getElementById('canvas');
      let ctx = canvas.getContext('2d');
      
      canvas.width = 67;
      canvas.height = 67;
      ctx.drawImage(img, 0, 0, 67, 67);
      
      let imageData = ctx.getImageData(0, 0, 67, 67);
      let pixels = imageData.data;
      let rgb565Data = new Uint8Array(67 * 67 * 2);
      
      for(let i = 0; i < 67 * 67; i++) {
        let r = pixels[i * 4] >> 3;
        let g = pixels[i * 4 + 1] >> 2;
        let b = pixels[i * 4 + 2] >> 3;
        
        let rgb565 = (r << 11) | (g << 5) | b;
        
        rgb565Data[i * 2] = (rgb565 >> 8) & 0xFF;
        rgb565Data[i * 2 + 1] = rgb565 & 0xFF;
      }
      
      resolve(rgb565Data);
    };
    img.src = dataUrl;
  });
}

async function downloadPackage() {
  showStatus('‚è≥ Creating package...', 'success');
  
  let zip = new JSZip();
  
  let cleanCfg = JSON.parse(JSON.stringify(cfg));
  for(let m = 0; m < cleanCfg.menuCount; m++) {
    for(let i = 0; i < 12; i++) {
      delete cleanCfg.menus[m].buttons[i].imageData;
    }
  }
  
  zip.file('config.json', JSON.stringify(cleanCfg, null, 2));
  
  for(let m = 0; m < cfg.menuCount; m++) {
    for(let i = 0; i < 12; i++) {
      let btn = cfg.menus[m].buttons[i];
      if(btn.imageData) {
        let rgb565Data = await imageDataToRgb565(btn.imageData);
        zip.file('i_' + m + '_' + i + '.raw', rgb565Data);
      }
    }
  }
  
  zip.generateAsync({type: 'blob', compression: 'DEFLATE'}).then(function(blob) {
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = 'cyd_deck_config.zip';
    a.rel = 'noopener noreferrer';
    a.target = '_self';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => {
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 100);
    showStatus('‚úì Package downloaded!', 'success');
  });
}

function addMenu() {
  let newMenu = {
    name: 'Menu ' + (cfg.menuCount + 1),
    parent: -1,
    buttons: []
  };
  
  for(let i = 0; i < 12; i++) {
    newMenu.buttons.push({
      active: false,
      color: 0x2196,
      text: '',
      icon: '',
      action: '',
      target: -1,
      imageData: null
    });
  }
  
  cfg.menus.push(newMenu);
  cfg.menuCount++;
  activeMenu = cfg.menuCount - 1;
  render();
  showStatus('‚úì Menu added!', 'success');
}

function delMenu(m) {
  if(!confirm('Delete this menu?')) return;
  
  cfg.menus.splice(m, 1);
  cfg.menuCount--;
  
  for(let i = 0; i < cfg.menuCount; i++) {
    if(cfg.menus[i].parent > m) cfg.menus[i].parent--;
    else if(cfg.menus[i].parent === m) cfg.menus[i].parent = -1;
    
    for(let j = 0; j < 12; j++) {
      if(cfg.menus[i].buttons[j].target > m) cfg.menus[i].buttons[j].target--;
      else if(cfg.menus[i].buttons[j].target === m) cfg.menus[i].buttons[j].target = -1;
    }
  }
  
  if(activeMenu >= cfg.menuCount) activeMenu = cfg.menuCount - 1;
  if(activeMenu < 0) activeMenu = 0;
  
  render();
  showStatus('‚úì Menu deleted!', 'success');
}

function loadConfig() {
  document.getElementById('fileInput').click();
}

function handleFileLoad(event) {
  let file = event.target.files[0];
  if(!file) return;
  
  let reader = new FileReader();
  reader.onload = function(e) {
    try {
      let loaded = JSON.parse(e.target.result);
      if(loaded.menus && loaded.menuCount) {
        for(let m = 0; m < loaded.menuCount; m++) {
          for(let i = 0; i < 12; i++) {
            if(!loaded.menus[m].buttons[i].imageData) {
              loaded.menus[m].buttons[i].imageData = null;
            }
          }
        }
        cfg = loaded;
        activeMenu = 0;
        render();
        showStatus('‚úì Config loaded!', 'success');
      } else {
        showStatus('‚úó Invalid config file!', 'error');
      }
    } catch(err) {
      showStatus('‚úó Failed to parse JSON!', 'error');
    }
  };
  reader.readAsText(file);
  
  event.target.value = '';
}

render();
</script>
</body>
</html>