<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<meta name='viewport' content='width=device-width,initial-scale=1'>
<title>CYD Deck Editor</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Arial,sans-serif;background:#0a0e27;color:#e4e7eb;padding:0;overflow-x:hidden}
.top-bar{background:linear-gradient(135deg,#1a1f3a 0%,#2d1b4e 100%);border-bottom:2px solid #4a5568;padding:20px 30px;position:sticky;top:0;z-index:100;box-shadow:0 4px 20px rgba(0,0,0,0.4)}
.top-bar h1{color:#a78bfa;margin-bottom:15px;font-size:26px;font-weight:600;letter-spacing:0.5px}
.controls{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
.btn-primary{background:linear-gradient(135deg,#8b5cf6 0%,#6d28d9 100%);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s;box-shadow:0 2px 8px rgba(139,92,246,0.3)}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(139,92,246,0.5)}
.btn-secondary{background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s;box-shadow:0 2px 8px rgba(59,130,246,0.3)}
.btn-secondary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(59,130,246,0.5)}
.btn-danger{background:linear-gradient(135deg,#ef4444 0%,#b91c1c 100%);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s;box-shadow:0 2px 8px rgba(239,68,68,0.3)}
.btn-danger:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(239,68,68,0.5)}
.btn-help{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s;box-shadow:0 2px 8px rgba(16,185,129,0.3)}
.btn-help:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(16,185,129,0.5)}
.btn-style{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);color:#fff;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;transition:all 0.3s;box-shadow:0 2px 8px rgba(245,158,11,0.3)}
.btn-style:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(245,158,11,0.5)}
.menu-tabs{display:flex;gap:8px;overflow-x:auto;padding:20px 30px;background:#12172e;border-bottom:1px solid #2d3748;scrollbar-width:thin;scrollbar-color:#4a5568 #1a202c}
.menu-tabs::-webkit-scrollbar{height:8px}
.menu-tabs::-webkit-scrollbar-track{background:#1a202c}
.menu-tabs::-webkit-scrollbar-thumb{background:#4a5568;border-radius:4px}
.menu-tab{background:#1f2937;color:#9ca3af;border:1px solid #374151;padding:12px 24px;border-radius:8px;cursor:move;font-size:14px;font-weight:500;white-space:nowrap;transition:all 0.3s;position:relative;user-select:none;display:flex;align-items:center;gap:10px}
.menu-tab:hover{background:#374151;color:#e4e7eb}
.menu-tab.active{background:linear-gradient(135deg,#8b5cf6 0%,#6d28d9 100%);color:#fff;border-color:#8b5cf6;box-shadow:0 2px 8px rgba(139,92,246,0.4)}
.menu-tab.dragging{opacity:0.5;transform:scale(0.95)}
.menu-tab.drag-over{border-color:#10b981;border-width:2px}
.menu-tab-actions{display:flex;gap:4px}
.tab-btn{background:rgba(0,0,0,0.3);border:none;color:#fff;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:11px;transition:all 0.2s}
.tab-btn:hover{background:rgba(0,0,0,0.5)}
.tab-btn.copy{background:rgba(16,185,129,0.3)}
.tab-btn.copy:hover{background:rgba(16,185,129,0.5)}
.container{max-width:1400px;margin:0 auto;padding:30px}
.menu{background:#161b33;padding:30px;border-radius:16px;margin-bottom:25px;border:1px solid #2d3748;box-shadow:0 4px 16px rgba(0,0,0,0.3);display:none}
.menu.active{display:block}
.menu-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;gap:15px;flex-wrap:wrap;padding-bottom:20px;border-bottom:2px solid #2d3748}
.menu-header input{flex:1;min-width:250px;background:#0f1629;color:#e4e7eb;border:2px solid #374151;padding:12px 16px;border-radius:10px;font-size:15px;transition:all 0.3s}
.menu-header input:focus{outline:none;border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,0.1)}
.menu-info{display:flex;gap:15px;align-items:center;flex-wrap:wrap}
.color-controls{background:#0f1629;padding:20px;border-radius:12px;margin-bottom:20px;border:1px solid #2d3748}
.color-controls h3{color:#a78bfa;font-size:16px;margin-bottom:15px;font-weight:600}
.color-options{display:flex;gap:15px;flex-wrap:wrap;align-items:center}
.color-select-group{display:flex;gap:10px;align-items:center}
.btn-color{background:#1f2937;color:#e4e7eb;border:1px solid #374151;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;transition:all 0.3s}
.btn-color:hover{background:#374151;border-color:#8b5cf6}
label.select-label{color:#9ca3af;font-size:13px;font-weight:500;margin-right:8px}
select{background:#0f1629;color:#e4e7eb;border:2px solid #374151;padding:10px 14px;border-radius:8px;font-size:14px;cursor:pointer;transition:all 0.3s}
select:focus{outline:none;border-color:#8b5cf6}
.btn-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px;margin-top:25px}
.btn-config{background:#0f1629;padding:24px;border-radius:12px;border:1px solid #2d3748;transition:all 0.3s;position:relative}
.btn-config:hover{border-color:#4a5568;box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.btn-config.has-image{border-color:#10b981}
.image-indicator{position:absolute;top:10px;right:10px;background:#10b981;color:#fff;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600}
.btn-config h3{color:#a78bfa;font-size:15px;margin-bottom:18px;font-weight:600;padding-bottom:12px;border-bottom:1px solid #2d3748}
.btn-config label{display:block;margin:14px 0 8px;color:#9ca3af;font-size:13px;font-weight:500}
.btn-config input[type=text],.btn-config input[type=number]{width:100%;background:#1a1f3a;color:#e4e7eb;border:1px solid #374151;padding:10px 12px;border-radius:8px;font-size:14px;transition:all 0.3s}
.btn-config input[type=text]:focus,.btn-config input[type=number]:focus{outline:none;border-color:#8b5cf6;box-shadow:0 0 0 3px rgba(139,92,246,0.1)}
.btn-config select{width:100%;background:#1a1f3a;color:#e4e7eb;border:1px solid #374151;padding:10px 12px;border-radius:8px;font-size:14px}
.checkbox-label{display:flex;align-items:center;margin:14px 0;cursor:pointer;user-select:none}
.checkbox-label input[type=checkbox]{width:20px;height:20px;margin-right:10px;cursor:pointer;accent-color:#8b5cf6}
.checkbox-label span{color:#e4e7eb;font-size:14px;font-weight:500}
.color-row{display:flex;gap:12px;align-items:center}
.color-preview{width:50px;height:40px;border-radius:8px;border:2px solid #374151;cursor:pointer;transition:all 0.3s;box-shadow:0 2px 6px rgba(0,0,0,0.3)}
.color-preview:hover{transform:scale(1.05);border-color:#8b5cf6}
.image-upload-area{margin-top:12px;padding:15px;background:#1a1f3a;border:2px dashed #374151;border-radius:8px;text-align:center;cursor:pointer;transition:all 0.3s}
.image-upload-area:hover{border-color:#8b5cf6;background:#0f1629}
.image-upload-area.has-image{border-style:solid;border-color:#10b981}
.upload-label{display:block;color:#9ca3af;font-size:13px;margin-bottom:10px}
.image-preview-container{display:flex;align-items:center;justify-content:center;gap:15px;flex-wrap:wrap}
.image-preview{width:67px;height:67px;border:2px solid #4a5568;border-radius:6px;object-fit:cover;background:#0a0e27}
.upload-info{color:#60a5fa;font-size:12px;margin-top:8px}
.remove-image{background:#ef4444;color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer;margin-top:8px}
.remove-image:hover{background:#dc2626}
input[type=file]{display:none}
.status{position:fixed;bottom:30px;right:30px;padding:16px 24px;border-radius:10px;display:none;font-size:14px;font-weight:500;box-shadow:0 4px 16px rgba(0,0,0,0.4);z-index:1000;animation:slideIn 0.3s ease}
.status.success{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff}
.status.error{background:linear-gradient(135deg,#ef4444 0%,#b91c1c 100%);color:#fff}
@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:2000;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:#161b33;border-radius:16px;padding:40px;max-width:800px;max-height:80vh;overflow-y:auto;border:2px solid #4a5568;box-shadow:0 8px 32px rgba(0,0,0,0.6);position:relative}
.modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:15px;border-bottom:2px solid #2d3748}
.modal-header h2{color:#a78bfa;font-size:24px;font-weight:600}
.modal-close{background:#ef4444;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:500}
.modal-close:hover{background:#dc2626}
.modal-body{color:#e4e7eb;line-height:1.8;font-size:15px}
.modal-body h3{color:#a78bfa;margin-top:20px;margin-bottom:10px;font-size:18px}
.modal-body p{margin-bottom:15px}
.modal-body ul{margin-left:20px;margin-bottom:15px}
.modal-body li{margin-bottom:8px}
.modal-body code{background:#0f1629;padding:2px 6px;border-radius:4px;color:#60a5fa}
.style-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-top:20px}
.style-section{background:#0f1629;padding:20px;border-radius:12px;border:1px solid #2d3748}
.style-section h3{color:#a78bfa;font-size:16px;margin-bottom:15px;font-weight:600;padding-bottom:10px;border-bottom:1px solid #2d3748}
.style-field{margin-bottom:15px}
.style-field label{display:block;color:#9ca3af;font-size:13px;font-weight:500;margin-bottom:8px}
.style-field input{width:100%;background:#1a1f3a;color:#e4e7eb;border:1px solid #374151;padding:10px 12px;border-radius:8px;font-size:14px}
.style-field input:focus{outline:none;border-color:#8b5cf6}
.color-array{display:flex;gap:10px}
.color-array input{flex:1}
canvas{display:none}
</style>
</head>
<body>
<div class='top-bar'>
<h1>CheapYellowDisplayDeck Editor by HIGHVOLTAGEBEE</h1>
<div class='controls'>
<button class='btn-primary' onclick='downloadPackage()'>Download Package (ZIP)</button>
<button class='btn-secondary' onclick='loadConfig()'>Load config.json</button>
<button class='btn-style' onclick='openStyleConfig()'>‚öôÔ∏è Style Config</button>
<button class='btn-secondary' onclick='addMenu()'>Add Menu</button>
<button class='btn-help' onclick='openHelp()'>Help</button>
<button class='btn-secondary' onclick='location.reload()'>Reset Editor</button>
</div>
</div>
<input type='file' id='fileInput' accept='.json' onchange='handleFileLoad(event)'>
<input type='file' id='imageInput' accept='image/*' onchange='handleImageUpload(event)'>
<input type='file' id='zipInput' accept='.zip' onchange='handleZipLoad(event)'>
<div class='menu-tabs' id='tabs'></div>
<div class='container' id='menus'></div>
<div class='status' id='status'></div>

<div class='modal' id='helpModal'>
<div class='modal-content'>
<div class='modal-header'>
<h2>üìñ Documentation</h2>
<button class='modal-close' onclick='closeHelp()'>‚úï Close</button>
</div>
<div class='modal-body'>
<h3>Welcome to CYD Deck Editor</h3>
<h3>Action Types</h3>
<ul>
<li><strong>Hotkey:</strong> Send keyboard combinations (e.g., <code>CTRL+C</code>, <code>ALT+F4</code>)</li>
<li><strong>Type String:</strong> Type text automatically (e.g., <code>Hello World</code>)</li>
<li><strong>Open Link:</strong> Open URLs in browser (e.g., <code>https://google.com</code>)</li>
<li><strong>Open Path:</strong> Open files or folders (e.g., <code>C:\Users\Documents</code>)</li>
<li><strong>CMD Command:</strong> Execute command line commands (e.g., <code>dir</code>)</li>
<li><strong>Combination:</strong> Combine multiple actions (e.g., <code>CTRL+C+"paste text"</code>)</li>
<li><strong>Menu Link:</strong> Navigate to another menu</li>
</ul>
<h3>Hotkey Format</h3>
<ul>
<li><strong>Modifiers:</strong> CTRL, ALT, SHIFT, WIN, FN</li>
<li><strong>Special Keys:</strong> ENTER, SPACE, TAB, ESC, BACKSPACE, DELETE, F1-F24</li>
<li><strong>Navigation:</strong> UP, DOWN, LEFT, RIGHT, HOME, END, PAGEUP, PAGEDOWN</li>
<li><strong>Examples:</strong> <code>CTRL+C</code>, <code>WIN+D</code>, <code>ALT+TAB</code></li>
</ul>
<h3>Basic Functions</h3>
<ul>
<li><strong>Create Menus:</strong> Click "Add Menu" to add new menus</li>
<li><strong>Move Menus:</strong> Drag menu tabs to reorder them</li>
<li><strong>Copy Menus:</strong> Click the copy button in a menu tab</li>
<li><strong>Configure Buttons:</strong> Each menu has 12 configurable buttons</li>
<li><strong>Upload Images:</strong> Click the upload area to add 67x67px icons</li>
<li><strong>Set Colors:</strong> Use bulk color functions for quick styling</li>
<li><strong>Style Config:</strong> Configure LED colors, timeouts, and display settings</li>
<li><strong>Save Config:</strong> Download your finished package as ZIP</li>
</ul>
<h3>Bulk Color Function</h3>
<p>Use the buttons to set colors for multiple buttons at once:</p>
<ul>
<li><strong>Single Button:</strong> Select a button from the dropdown</li>
<li><strong>Entire Row:</strong> Set all buttons in a horizontal row (1-4)</li>
<li><strong>Entire Column:</strong> Set all buttons in a vertical column (1-3)</li>
<li><strong>All Buttons:</strong> Change all 12 buttons at once</li>
</ul>
<p><em>Note: Buttons with images are automatically skipped.</em></p>
</div>
</div>
</div>

<div class='modal' id='styleModal'>
<div class='modal-content'>
<div class='modal-header'>
<h2>‚öôÔ∏è Style Configuration</h2>
<button class='modal-close' onclick='closeStyleConfig()'>‚úï Close</button>
</div>
<div class='modal-body'>
<div class='style-grid'>
<div class='style-section'>
<h3>General Settings</h3>
<div class='style-field'>
<label>LED Enabled</label>
<div class='checkbox-label'>
<input type='checkbox' id='ledEnabled' checked onchange='updateStyleConfig()'>
<span>Enable LED</span>
</div>
</div>
<div class='style-field'>
<label>Sleep Timeout (ms)</label>
<input type='number' id='sleepTimeout' value='5000' onchange='updateStyleConfig()'>
</div>
<div class='style-field'>
<label>Screen Update Interval (ms)</label>
<input type='number' id='screenUpdateInterval' value='5' onchange='updateStyleConfig()'>
</div>
<div class='style-field'>
<label>OK Interval (ms)</label>
<input type='number' id='okInterval' value='600' onchange='updateStyleConfig()'>
</div>
<div class='style-field'>
<label>LED Brightness (0-255)</label>
<input type='number' id='ledBrightness' min='0' max='255' value='10' onchange='updateStyleConfig()'>
</div>
</div>
<div class='style-section'>
<h3>LED Colors (RGB)</h3>
<div class='style-field'>
<label>Connected Color</label>
<div class='color-array'>
<input type='number' id='ledColorConnected0' min='0' max='255' value='0' placeholder='R' onchange='updateStyleConfig()'>
<input type='number' id='ledColorConnected1' min='0' max='255' value='255' placeholder='G' onchange='updateStyleConfig()'>
<input type='number' id='ledColorConnected2' min='0' max='255' value='0' placeholder='B' onchange='updateStyleConfig()'>
</div>
</div>
<div class='style-field'>
<label>Disconnected Color</label>
<div class='color-array'>
<input type='number' id='ledColorDisconnected0' min='0' max='255' value='255' placeholder='R' onchange='updateStyleConfig()'>
<input type='number' id='ledColorDisconnected1' min='0' max='255' value='0' placeholder='G' onchange='updateStyleConfig()'>
<input type='number' id='ledColorDisconnected2' min='0' max='255' value='0' placeholder='B' onchange='updateStyleConfig()'>
</div>
</div>
<div class='style-field'>
<label>Active Color</label>
<div class='color-array'>
<input type='number' id='ledColorActive0' min='0' max='255' value='0' placeholder='R' onchange='updateStyleConfig()'>
<input type='number' id='ledColorActive1' min='0' max='255' value='255' placeholder='G' onchange='updateStyleConfig()'>
<input type='number' id='ledColorActive2' min='0' max='255' value='0' placeholder='B' onchange='updateStyleConfig()'>
</div>
</div>
<div class='style-field'>
<label>Button Color</label>
<div class='color-array'>
<input type='number' id='ledColorButton0' min='0' max='255' value='255' placeholder='R' onchange='updateStyleConfig()'>
<input type='number' id='ledColorButton1' min='0' max='255' value='165' placeholder='G' onchange='updateStyleConfig()'>
<input type='number' id='ledColorButton2' min='0' max='255' value='0' placeholder='B' onchange='updateStyleConfig()'>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<canvas id='canvas'></canvas>
<script>
let cfg={menuCount:1,menus:[{name:'Main Menu',parent:-1,buttons:[]}],styleConfig:{ledEnabled:true,sleepTimeout:5000,screenUpdateInterval:5,okInterval:600,ledColorConnected:[0,255,0],ledColorDisconnected:[255,0,0],ledColorActive:[0,255,0],ledColorButton:[255,165,0],ledBrightness:10}};
for(let i=0;i<12;i++){cfg.menus[0].buttons.push({active:false,color:0x2196,text:'',icon:'',action:'',target:-1,imageData:null});}
let activeMenu=0;
let currentUploadButton=null;
let draggedMenu=null;

function showStatus(msg,type){type=type||'success';let s=document.getElementById('status');s.textContent=msg;s.className='status '+type;s.style.display='block';setTimeout(()=>s.style.display='none',3000);}
function switchMenu(idx){activeMenu=idx;render();}
function openHelp(){document.getElementById('helpModal').classList.add('active');}
function closeHelp(){document.getElementById('helpModal').classList.remove('active');}
function openStyleConfig(){loadStyleConfig();document.getElementById('styleModal').classList.add('active');}
function closeStyleConfig(){document.getElementById('styleModal').classList.remove('active');}

function loadStyleConfig(){let s=cfg.styleConfig;document.getElementById('ledEnabled').checked=s.ledEnabled;document.getElementById('sleepTimeout').value=s.sleepTimeout;document.getElementById('screenUpdateInterval').value=s.screenUpdateInterval;document.getElementById('okInterval').value=s.okInterval;document.getElementById('ledBrightness').value=s.ledBrightness;document.getElementById('ledColorConnected0').value=s.ledColorConnected[0];document.getElementById('ledColorConnected1').value=s.ledColorConnected[1];document.getElementById('ledColorConnected2').value=s.ledColorConnected[2];document.getElementById('ledColorDisconnected0').value=s.ledColorDisconnected[0];document.getElementById('ledColorDisconnected1').value=s.ledColorDisconnected[1];document.getElementById('ledColorDisconnected2').value=s.ledColorDisconnected[2];document.getElementById('ledColorActive0').value=s.ledColorActive[0];document.getElementById('ledColorActive1').value=s.ledColorActive[1];document.getElementById('ledColorActive2').value=s.ledColorActive[2];document.getElementById('ledColorButton0').value=s.ledColorButton[0];document.getElementById('ledColorButton1').value=s.ledColorButton[1];document.getElementById('ledColorButton2').value=s.ledColorButton[2];}

function updateStyleConfig(){cfg.styleConfig={ledEnabled:document.getElementById('ledEnabled').checked,sleepTimeout:parseInt(document.getElementById('sleepTimeout').value),screenUpdateInterval:parseInt(document.getElementById('screenUpdateInterval').value),okInterval:parseInt(document.getElementById('okInterval').value),ledColorConnected:[parseInt(document.getElementById('ledColorConnected0').value),parseInt(document.getElementById('ledColorConnected1').value),parseInt(document.getElementById('ledColorConnected2').value)],ledColorDisconnected:[parseInt(document.getElementById('ledColorDisconnected0').value),parseInt(document.getElementById('ledColorDisconnected1').value),parseInt(document.getElementById('ledColorDisconnected2').value)],ledColorActive:[parseInt(document.getElementById('ledColorActive0').value),parseInt(document.getElementById('ledColorActive1').value),parseInt(document.getElementById('ledColorActive2').value)],ledColorButton:[parseInt(document.getElementById('ledColorButton0').value),parseInt(document.getElementById('ledColorButton1').value),parseInt(document.getElementById('ledColorButton2').value)],ledBrightness:parseInt(document.getElementById('ledBrightness').value)};}

function applyBulkColor(){let colorType=document.getElementById('colorType_'+activeMenu).value;let colorValue=document.getElementById('bulkColorPicker_'+activeMenu).value;let rgb565=hexToRgb565(colorValue);let menu=cfg.menus[activeMenu];if(colorType==='all'){for(let i=0;i<12;i++){if(!menu.buttons[i].imageData){menu.buttons[i].color=rgb565;}}showStatus('‚úì Color applied to all buttons!','success');}else if(colorType.startsWith('row')){let row=parseInt(colorType.replace('row',''))-1;for(let i=0;i<3;i++){let idx=row*3+i;if(!menu.buttons[idx].imageData){menu.buttons[idx].color=rgb565;}}showStatus('‚úì Color applied to row!','success');}else if(colorType.startsWith('col')){let col=parseInt(colorType.replace('col',''))-1;for(let i=0;i<4;i++){let idx=i*3+col;if(!menu.buttons[idx].imageData){menu.buttons[idx].color=rgb565;}}showStatus('‚úì Color applied to column!','success');}else{let btnIdx=parseInt(colorType.replace('btn',''))-1;if(!menu.buttons[btnIdx].imageData){menu.buttons[btnIdx].color=rgb565;showStatus('‚úì Color applied to button!','success');}else{showStatus('‚úó Button already has an image!','error');}}render();}

function copyMenu(m){let source=cfg.menus[m];let newMenu={name:source.name+' (Copy)',parent:source.parent,buttons:[]};for(let i=0;i<12;i++){let btn=source.buttons[i];newMenu.buttons.push({active:btn.active,color:btn.color,text:btn.text,icon:btn.icon,action:btn.action,target:btn.target,imageData:btn.imageData});}cfg.menus.splice(m+1,0,newMenu);cfg.menuCount++;updateIndices();activeMenu=m+1;render();showStatus('‚úì Menu copied!','success');}

function moveMenu(fromIdx,toIdx){if(fromIdx===toIdx||toIdx<0||toIdx>=cfg.menuCount)return;let indexMap=new Array(cfg.menuCount);if(fromIdx<toIdx){for(let i=0;i<cfg.menuCount;i++){if(i===fromIdx){indexMap[i]=toIdx;}else if(i>fromIdx&&i<=toIdx){indexMap[i]=i-1;}else{indexMap[i]=i;}}}else{for(let i=0;i<cfg.menuCount;i++){if(i===fromIdx){indexMap[i]=toIdx;}else if(i>=toIdx&&i<fromIdx){indexMap[i]=i+1;}else{indexMap[i]=i;}}}let menu=cfg.menus.splice(fromIdx,1)[0];cfg.menus.splice(toIdx,0,menu);for(let i=0;i<cfg.menuCount;i++){let m=cfg.menus[i];if(m.parent>=0){m.parent=indexMap[m.parent];}for(let j=0;j<12;j++){let btn=m.buttons[j];if(btn.target>=0){btn.target=indexMap[btn.target];}}}activeMenu=toIdx;render();showStatus('‚úì Menu moved! All references updated.','success');}

function updateIndices(){for(let i=0;i<cfg.menuCount;i++){let menu=cfg.menus[i];if(menu.parent>=cfg.menuCount)menu.parent=-1;for(let j=0;j<12;j++){let btn=menu.buttons[j];if(btn.target>=cfg.menuCount)btn.target=-1;}}}

function handleDragStart(e,idx){draggedMenu=idx;e.target.classList.add('dragging');e.dataTransfer.effectAllowed='move';e.dataTransfer.setData('text/html',e.target.innerHTML);}
function handleDragEnd(e){e.target.classList.remove('dragging');document.querySelectorAll('.menu-tab').forEach(t=>t.classList.remove('drag-over'));draggedMenu=null;}
function handleDragOver(e){if(e.preventDefault){e.preventDefault();}e.dataTransfer.dropEffect='move';return false;}
function handleDragEnter(e){e.target.closest('.menu-tab').classList.add('drag-over');}
function handleDragLeave(e){e.target.closest('.menu-tab').classList.remove('drag-over');}
function handleDrop(e,idx){if(e.stopPropagation){e.stopPropagation();}if(draggedMenu!==null&&draggedMenu!==idx){moveMenu(draggedMenu,idx);}return false;}

function formatAction(type,value){if(type==='hotkey'||type==='combination')return value;if(type==='typestring')return '"'+value+'"';if(type==='openpath')return '<'+value+'>';if(type==='cmdcommand')return "'"+value+"'";if(type==='openlink')return value;return value;}

function parseAction(action){if(!action)return{type:'hotkey',value:''};if(action.startsWith('"')&&action.endsWith('"'))return{type:'typestring',value:action.slice(1,-1)};if(action.startsWith('<')&&action.endsWith('>'))return{type:'openpath',value:action.slice(1,-1)};if(action.startsWith("'")&&action.endsWith("'"))return{type:'cmdcommand',value:action.slice(1,-1)};if(action.includes('http://')||action.includes('https://'))return{type:'openlink',value:action};return{type:'hotkey',value:action};}

function render(){let tabs='';for(let m=0;m<cfg.menuCount;m++){tabs+="<div class='menu-tab "+(m===activeMenu?"active":"")+"' draggable='true' ondragstart='handleDragStart(event,"+m+")' ondragend='handleDragEnd(event)' ondragover='handleDragOver(event)' ondragenter='handleDragEnter(event)' ondragleave='handleDragLeave(event)' ondrop='handleDrop(event,"+m+")'>";tabs+="<span onclick='switchMenu("+m+")' style='cursor:pointer'>"+cfg.menus[m].name+"</span>";tabs+="<div class='menu-tab-actions'>";tabs+="<button class='tab-btn copy' onclick='event.stopPropagation();copyMenu("+m+")' title='Copy menu'>üìã</button>";tabs+="</div></div>";}document.getElementById('tabs').innerHTML=tabs;let h='';for(let m=0;m<cfg.menuCount;m++){let menu=cfg.menus[m];h+="<div class='menu "+(m===activeMenu?"active":"")+"'><div class='menu-header'><input type='text' value='"+menu.name+"' onchange='cfg.menus["+m+"].name=this.value;render()' placeholder='Menu Name'>";h+="<div class='menu-info'><label class='select-label'>Parent Menu:</label><select onchange='cfg.menus["+m+"].parent=parseInt(this.value)'><option value='-1'>Main Menu</option>";for(let i=0;i<cfg.menuCount;i++){if(i!==m){h+="<option value='"+i+"' "+(menu.parent===i?"selected":"")+">"+cfg.menus[i].name+"</option>";}}h+="</select><button class='btn-danger' onclick='event.preventDefault();delMenu("+m+");'>üóëÔ∏è Delete Menu</button></div></div>";h+="<div class='color-controls'><h3>üé® Bulk Color Function</h3><div class='color-options'>";h+="<div class='color-select-group'><label class='select-label'>Area:</label>";h+="<select id='colorType_"+m+"'>";h+="<option value='all'>All Buttons</option>";for(let r=1;r<=4;r++){h+="<option value='row"+r+"'>Row "+r+"</option>";}for(let c=1;c<=3;c++){h+="<option value='col"+c+"'>Column "+c+"</option>";}for(let b=1;b<=12;b++){h+="<option value='btn"+b+"'>Button "+b+"</option>";}h+="</select></div>";h+="<label class='select-label'>Color:</label>";h+="<div class='color-row'><div class='color-preview' id='bulkColorPreview_"+m+"' style='background:#2196f3' onclick='document.getElementById(\"bulkColorPicker_"+m+"\").click()'></div>";h+="<input type='color' id='bulkColorPicker_"+m+"' style='display:none' value='#2196f3' onchange='document.getElementById(\"bulkColorPreview_"+m+"\").style.background=this.value'>";h+="<button class='btn-color' onclick='applyBulkColor()'>Apply Color</button></div>";h+="</div></div>";h+="<div class='btn-grid'>";for(let i=0;i<12;i++){let b=menu.buttons[i];let hasImage=b.imageData?" has-image":"";let parsed=parseAction(b.action);h+="<div class='btn-config"+hasImage+"'>";if(b.imageData){h+="<span class='image-indicator'>üì∑ Image</span>";}h+="<h3>Button "+(i+1)+"</h3>";h+="<div class='checkbox-label'><input type='checkbox' "+(b.active?"checked":"")+" onchange='cfg.menus["+m+"].buttons["+i+"].active=this.checked'><span>Active</span></div>";if(!b.imageData){h+="<label>Button Text</label><input type='text' value='"+b.text+"' onchange='cfg.menus["+m+"].buttons["+i+"].text=this.value'>";}h+="<label>Action Type</label><select id='actionType_"+m+"_"+i+"' onchange='updateActionType("+m+","+i+",this.value)'>";h+="<option value='hotkey' "+(b.target<0&&parsed.type==='hotkey'?"selected":"")+">Hotkey</option>";h+="<option value='typestring' "+(parsed.type==='typestring'?"selected":"")+">Type String</option>";h+="<option value='openlink' "+(parsed.type==='openlink'?"selected":"")+">Open Link</option>";h+="<option value='openpath' "+(parsed.type==='openpath'?"selected":"")+">Open Path</option>";h+="<option value='cmdcommand' "+(parsed.type==='cmdcommand'?"selected":"")+">CMD Command</option>";h+="<option value='combination' "+(b.target<0&&parsed.type!=='typestring'&&parsed.type!=='openlink'&&parsed.type!=='openpath'&&parsed.type!=='cmdcommand'&&parsed.type!=='hotkey'?"selected":"")+">Combination</option>";h+="<option value='menu' "+(b.target>=0?"selected":"")+">Menu Link</option></select>";h+="<div id='act_"+m+"_"+i+"'>";if(b.target<0){let actionLabel='Hotkey Combination';let placeholder='CTRL+C';if(parsed.type==='typestring'){actionLabel='Text to Type';placeholder='Hello World';}else if(parsed.type==='openlink'){actionLabel='URL';placeholder='https://google.com';}else if(parsed.type==='openpath'){actionLabel='File/Folder Path';placeholder='C:\\Users\\Documents';}else if(parsed.type==='cmdcommand'){actionLabel='Command';placeholder='dir';}else if(parsed.type==='combination'){actionLabel='Combined Actions';placeholder='CTRL+C+"text"';}h+="<label>"+actionLabel+"</label><input type='text' id='actionInput_"+m+"_"+i+"' value='"+parsed.value+"' onchange='updateActionValue("+m+","+i+")' placeholder='"+placeholder+"'>";}else{h+="<label>Target Menu</label><select onchange='cfg.menus["+m+"].buttons["+i+"].target=parseInt(this.value)'><option value='-1'>None</option>";for(let mn=0;mn<cfg.menuCount;mn++){h+="<option value='"+mn+"' "+(b.target===mn?"selected":"")+">"+cfg.menus[mn].name+"</option>";}h+="</select>";}h+="</div>";if(!b.imageData){h+="<label>Button Color</label><div class='color-row'><div class='color-preview' style='background:#"+rgb565ToHex(b.color)+"' onclick='document.getElementById(\"col_"+m+"_"+i+"\").click()'></div>";h+="<input type='color' id='col_"+m+"_"+i+"' style='display:none' value='#"+rgb565ToHex(b.color)+"' onchange='cfg.menus["+m+"].buttons["+i+"].color=hexToRgb565(this.value);render()'>";h+="</div>";}h+="<label>Button Icon (67x67px)</label>";h+="<div class='image-upload-area "+(b.imageData?"has-image":"")+"' onclick='openImageUpload("+m+","+i+")'>";if(b.imageData){h+="<div class='image-preview-container'>";h+="<img src='"+b.imageData+"' class='image-preview' alt='Preview'>";h+="<div><span class='upload-info'>‚úì Image ready</span><br>";h+="<button class='remove-image' onclick='event.stopPropagation();removeImage("+m+","+i+")'>Remove</button></div>";h+="</div>";}else{h+="<span class='upload-label'>üì∑ Click to upload image</span>";h+="<span class='upload-info'>Accepts: JPG, PNG, GIF, WebP</span>";}h+="</div></div>";}h+="</div></div>";}document.getElementById('menus').innerHTML=h;}

function updateActionType(m,i,type){let b=cfg.menus[m].buttons[i];if(type==='menu'){b.action='';b.target=0;}else{b.action='';b.target=-1;}render();}

function updateActionValue(m,i){let type=document.getElementById('actionType_'+m+'_'+i).value;let value=document.getElementById('actionInput_'+m+'_'+i).value;cfg.menus[m].buttons[i].action=formatAction(type,value);}

function hexToRgb565(hex){let r=parseInt(hex.slice(1,3),16)>>3;let g=parseInt(hex.slice(3,5),16)>>2;let b=parseInt(hex.slice(5,7),16)>>3;return(r<<11)|(g<<5)|b;}

function rgb565ToHex(rgb565){let r=((rgb565>>11)&0x1F)<<3;let g=((rgb565>>5)&0x3F)<<2;let b=(rgb565&0x1F)<<3;r=r|(r>>5);g=g|(g>>6);b=b|(b>>5);return r.toString(16).padStart(2,'0')+g.toString(16).padStart(2,'0')+b.toString(16).padStart(2,'0');}

function openImageUpload(m,i){currentUploadButton={menu:m,button:i};document.getElementById('imageInput').click();}

function handleImageUpload(event){let file=event.target.files[0];if(!file||!currentUploadButton)return;let reader=new FileReader();reader.onload=function(e){let img=new Image();img.onload=function(){let canvas=document.getElementById('canvas');let ctx=canvas.getContext('2d');canvas.width=67;canvas.height=67;ctx.drawImage(img,0,0,67,67);let dataUrl=canvas.toDataURL('image/png');cfg.menus[currentUploadButton.menu].buttons[currentUploadButton.button].imageData=dataUrl;cfg.menus[currentUploadButton.menu].buttons[currentUploadButton.button].icon='/i_'+currentUploadButton.menu+'_'+currentUploadButton.button+'.raw';cfg.menus[currentUploadButton.menu].buttons[currentUploadButton.button].color=0x0000;cfg.menus[currentUploadButton.menu].buttons[currentUploadButton.button].text='';render();showStatus('‚úì Image uploaded and resized!','success');};img.src=e.target.result;};reader.readAsDataURL(file);event.target.value='';}

function removeImage(m,i){cfg.menus[m].buttons[i].imageData=null;cfg.menus[m].buttons[i].icon='';cfg.menus[m].buttons[i].text='';render();showStatus('‚úì Image removed!','success');}

function imageDataToRgb565(dataUrl){return new Promise((resolve)=>{let img=new Image();img.onload=function(){let canvas=document.getElementById('canvas');let ctx=canvas.getContext('2d');canvas.width=67;canvas.height=67;ctx.drawImage(img,0,0,67,67);let imageData=ctx.getImageData(0,0,67,67);let pixels=imageData.data;let rgb565Data=new Uint8Array(67*67*2);for(let i=0;i<67*67;i++){let r=pixels[i*4]>>3;let g=pixels[i*4+1]>>2;let b=pixels[i*4+2]>>3;let rgb565=(r<<11)|(g<<5)|b;rgb565Data[i*2]=(rgb565>>8)&0xFF;rgb565Data[i*2+1]=rgb565&0xFF;}resolve(rgb565Data);};img.src=dataUrl;});}

async function downloadPackage(){showStatus('‚è≥ Creating package...','success');let zip=new JSZip();let cleanCfg=JSON.parse(JSON.stringify(cfg));for(let m=0;m<cleanCfg.menuCount;m++){for(let i=0;i<12;i++){delete cleanCfg.menus[m].buttons[i].imageData;}}zip.file('config.json',JSON.stringify(cleanCfg,null,2));for(let m=0;m<cfg.menuCount;m++){for(let i=0;i<12;i++){let btn=cfg.menus[m].buttons[i];if(btn.imageData){let rgb565Data=await imageDataToRgb565(btn.imageData);zip.file('i_'+m+'_'+i+'.raw',rgb565Data);}}}zip.generateAsync({type:'blob'}).then(function(blob){let url=URL.createObjectURL(blob);let a=document.createElement('a');a.href=url;a.download='cyd_deck_config.zip';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);showStatus('‚úì Package downloaded!','success');});}

function addMenu(){let newMenu={name:'Menu '+(cfg.menuCount+1),parent:-1,buttons:[]};for(let i=0;i<12;i++){newMenu.buttons.push({active:false,color:0x2196,text:'',icon:'',action:'',target:-1,imageData:null});}cfg.menus.push(newMenu);cfg.menuCount++;activeMenu=cfg.menuCount-1;render();showStatus('‚úì Menu added!','success');}

function delMenu(m){if(!confirm('Delete this menu?'))return;cfg.menus.splice(m,1);cfg.menuCount--;for(let i=0;i<cfg.menuCount;i++){if(cfg.menus[i].parent>m)cfg.menus[i].parent--;else if(cfg.menus[i].parent===m)cfg.menus[i].parent=-1;for(let j=0;j<12;j++){if(cfg.menus[i].buttons[j].target>m)cfg.menus[i].buttons[j].target--;else if(cfg.menus[i].buttons[j].target===m)cfg.menus[i].buttons[j].target=-1;}}if(activeMenu>=cfg.menuCount)activeMenu=cfg.menuCount-1;if(activeMenu<0)activeMenu=0;render();showStatus('‚úì Menu deleted!','success');}

function loadConfig(){document.getElementById('fileInput').click();}

async function handleFileLoad(event){let file=event.target.files[0];if(!file)return;if(file.name.endsWith('.zip')){handleZipLoad(event);return;}let reader=new FileReader();reader.onload=function(e){try{let loaded=JSON.parse(e.target.result);if(loaded.menus&&loaded.menuCount){for(let m=0;m<loaded.menuCount;m++){for(let i=0;i<12;i++){if(!loaded.menus[m].buttons[i].imageData){loaded.menus[m].buttons[i].imageData=null;}}}if(!loaded.styleConfig){loaded.styleConfig={ledEnabled:true,sleepTimeout:5000,screenUpdateInterval:5,okInterval:600,ledColorConnected:[0,255,0],ledColorDisconnected:[255,0,0],ledColorActive:[0,255,0],ledColorButton:[255,165,0],ledBrightness:10};}cfg=loaded;activeMenu=0;render();showStatus('‚úì Config loaded!','success');}else{showStatus('‚úó Invalid config file!','error');}}catch(err){showStatus('‚úó Failed to parse JSON!','error');}};reader.readAsText(file);event.target.value='';}

async function handleZipLoad(event){let file=event.target.files[0];if(!file)return;showStatus('‚è≥ Loading ZIP package...','success');try{let zip=await JSZip.loadAsync(file);let configFile=zip.file('config.json');if(!configFile){showStatus('‚úó No config.json found in ZIP!','error');return;}let configText=await configFile.async('text');let loaded=JSON.parse(configText);if(!loaded.menus||!loaded.menuCount){showStatus('‚úó Invalid config file!','error');return;}if(!loaded.styleConfig){loaded.styleConfig={ledEnabled:true,sleepTimeout:5000,screenUpdateInterval:5,okInterval:600,ledColorConnected:[0,255,0],ledColorDisconnected:[255,0,0],ledColorActive:[0,255,0],ledColorButton:[255,165,0],ledBrightness:10};}for(let m=0;m<loaded.menuCount;m++){for(let i=0;i<12;i++){let btn=loaded.menus[m].buttons[i];btn.imageData=null;if(btn.icon&&btn.icon.startsWith('/i_')){let filename=btn.icon.substring(1);let imageFile=zip.file(filename);if(imageFile){let rawData=await imageFile.async('uint8array');let dataUrl=await rgb565ToDataUrl(rawData);btn.imageData=dataUrl;}}}}cfg=loaded;activeMenu=0;render();showStatus('‚úì ZIP package loaded with images!','success');}catch(err){showStatus('‚úó Failed to load ZIP: '+err.message,'error');}event.target.value='';}

function rgb565ToDataUrl(rgb565Data){return new Promise((resolve)=>{let canvas=document.getElementById('canvas');let ctx=canvas.getContext('2d');canvas.width=67;canvas.height=67;let imageData=ctx.createImageData(67,67);let pixels=imageData.data;for(let i=0;i<67*67;i++){let rgb565=(rgb565Data[i*2]<<8)|rgb565Data[i*2+1];let r=((rgb565>>11)&0x1F)<<3;let g=((rgb565>>5)&0x3F)<<2;let b=(rgb565&0x1F)<<3;r=r|(r>>5);g=g|(g>>6);b=b|(b>>5);pixels[i*4]=r;pixels[i*4+1]=g;pixels[i*4+2]=b;pixels[i*4+3]=255;}ctx.putImageData(imageData,0,0);resolve(canvas.toDataURL('image/png'));});}

render();
</script>
</body>
</html>